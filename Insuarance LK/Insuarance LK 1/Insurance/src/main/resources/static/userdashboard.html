<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Dashboard - MotorCare LK</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; background: #f8f9fa;
        }
        .user-layout {
            display: flex;
            min-height: 100vh;
        }
        .user-sidebar {
            width: 280px;
            background: linear-gradient(135deg, #4a69bd, #1e3799);
            color: white;
            padding: 1.5rem 1rem;
        }
        .user-sidebar-header {
            margin-bottom: 2rem;
            text-align: center;
        }
        .user-sidebar-header h3 {
            color: #ff6b35;
            margin-bottom: 0.5rem;
        }
        .user-sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .user-sidebar-item {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 1rem;
            border-left: 4px solid transparent;
            transition: background 0.3s, border-left 0.3s;
        }
        .user-sidebar-item:hover,
        .user-sidebar-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid #ff6b35;
        }
        .user-content {
            flex: 1;
            padding: 2rem;
            background: #fff;
            overflow-y: auto;
        }
        h2 {
            color: #4a69bd;
            margin-bottom: 1rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        form {
            max-width: 450px;
            margin-top: 1rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            margin-top: 1rem;
        }
        input, textarea {
            width: 100%;
            padding: 0.6rem;
            font-family: inherit;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        button.submit-btn {
            margin-top: 1rem;
            background-color: #4a69bd;
            color: white;
            font-weight: 700;
            border: none;
            border-radius: 25px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        button.submit-btn:hover {
            background-color: #3c5aa6;
        }
    </style>
</head>
<body>
<div class="user-layout">
    <aside class="user-sidebar">
        <div class="user-sidebar-header">
            <h3> User Panel</h3>
            <p>Personal Dashboard</p>
        </div>
        <nav class="user-sidebar-nav">
            <button class="user-sidebar-item active" onclick="showSection('home', event)"> Home</button>
            <button class="user-sidebar-item" onclick="showSection('profile', event)"> Profile</button>
            <button class="user-sidebar-item" onclick="showSection('editProfile', event)"> Edit Profile</button>
            <button class="user-sidebar-item" onclick="showSection('changePassword', event)"> Change Password</button>
            <button class="user-sidebar-item" onclick="navigateToPage('userpolicy.html')"> My Policies</button>
            <button class="user-sidebar-item" onclick="navigateToPage('userclaims.html')"> My Claims</button>
            <button class="user-sidebar-item" onclick="navigateToPage('userpayment.html')"> Payments</button>
            <button class="user-sidebar-item" onclick="navigateToPage('notificationuser.html')"> Notifications</button>
            <button class="user-sidebar-item" onclick="navigateToPage('userreport.html')"> Reports</button>
        </nav>
    </aside>
    <main class="user-content">
        <div id="userDashboardAlert" class="alert"></div>

        <section id="home" style="display:block;">
            <h2> Dashboard Overview</h2>
            <p>Welcome to your dashboard! Here you can see summarized info.</p>
        </section>

        <section id="profile" style="display:none;">
            <h2> My Profile</h2>
            <div>
                <p><strong>Name:</strong> <span id="profileName">Loading...</span></p>
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>NIC:</strong> <span id="profileNic"></span></p>
                <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
                <p><strong>Age:</strong> <span id="profileAge"></span></p>
                <p><strong>Address:</strong> <span id="profileAddress"></span></p>
            </div>
        </section>

        <section id="editProfile" style="display:none;">
            <h2>‚úè Edit Profile</h2>
            <form id="editProfileForm">
                <label for="editName">Name</label>
                <input type="text" id="editName" required />
                <label for="editEmail">Email</label>
                <input type="email" id="editEmail" required disabled />
                <label for="editNic">NIC</label>
                <input type="text" id="editNic" required />
                <label for="editPhone">Phone</label>
                <input type="tel" id="editPhone" required />
                <label for="editAge">Age</label>
                <input type="number" id="editAge" required min="1" />
                <label for="editAddress">Address</label>
                <textarea id="editAddress" rows="3" required></textarea>
                <button type="submit" class="submit-btn">Save Changes</button>
            </form>
        </section>

        <section id="changePassword" style="display:none;">
            <h2> Change Password</h2>
            <form id="changePasswordForm">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" required />
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required />
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" required />
                <button type="submit" class="submit-btn">Change Password</button>
            </form>
        </section>

    </main>
</div>
<script>
    const API_BASE_URL = 'http://localhost:8080/api';

    function navigateToPage(page) {
        window.location.href = page;
    }

    function showSection(sectionId, event) {
        document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
        document.querySelectorAll('.user-sidebar-item').forEach(btn => btn.classList.remove('active'));
        if (event) event.target.classList.add('active');

        if(sectionId === 'profile') loadUserProfile();
        else if(sectionId === 'editProfile') loadEditProfileForm();
    }

    function loadUserProfile() {
        const userJson = localStorage.getItem('loggedInUser');
        if (!userJson) {
            alert('Please login first.');
            window.location.href = 'userlogin.html';
            return;
        }
        const user = JSON.parse(userJson);
        document.getElementById('profileName').textContent = user.name || '';
        document.getElementById('profileEmail').textContent = user.email || '';
        document.getElementById('profileNic').textContent = user.nic || '';
        document.getElementById('profilePhone').textContent = user.telephone || '';
        document.getElementById('profileAge').textContent = user.age || '';
        document.getElementById('profileAddress').textContent = user.address || '';
    }

    function loadEditProfileForm() {
        const userJson = localStorage.getItem('loggedInUser');
        if (!userJson) {
            alert('Please login first.');
            window.location.href = 'userlogin.html';
            return;

        }
        const user = JSON.parse(userJson);

        document.getElementById('editName').value = user.name || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editNic').value = user.nic || '';
        document.getElementById('editPhone').value = user.telephone || '';
        document.getElementById('editAge').value = user.age || '';
        document.getElementById('editAddress').value = user.address || '';
    }

    document.getElementById('editProfileForm').addEventListener('submit', async function(evt) {
        evt.preventDefault();


        const updatedUser = {
            name: document.getElementById('editName').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            nic: document.getElementById('editNic').value.trim(),
            telephone: document.getElementById('editPhone').value.trim(),
            age: parseInt(document.getElementById('editAge').value),
            address: document.getElementById('editAddress').value.trim()
        };

        try {
            const response = await fetch(API_BASE_URL + '/user/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedUser)
            });
            const result = await response.json();
            const alertEl = document.getElementById('userDashboardAlert');
            if (result.success) {
                alertEl.textContent = result.message || 'Profile updated successfully';
                alertEl.className = 'alert alert-success show';

                // Update localStorage
                localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));

                // Refresh profile display
                loadUserProfile();
                showSection('profile');
            } else {
                alertEl.textContent = result.message || 'Failed to update profile';
                alertEl.className = 'alert alert-error show';
            }
        } catch (error) {
            const alertEl = document.getElementById('userDashboardAlert');
            alertEl.textContent = 'Error updating profile';
            alertEl.className = 'alert alert-error show';
        }
    });

    document.getElementById('changePasswordForm').addEventListener('submit', async function(evt) {
        evt.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }

        const userJson = localStorage.getItem('loggedInUser');
        if (!userJson) {
            alert('Please login first.');
            window.location.href = 'userlogin.html';
            return;
        }
        const user = JSON.parse(userJson);

        try {
            const response = await fetch(API_BASE_URL + '/user/change-password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user.email, oldPassword: currentPassword, newPassword })
            });
            const result = await response.json();
            const alertEl = document.getElementById('userDashboardAlert');
            if (result.success) {
                alertEl.textContent = result.message || 'Password changed successfully';
                alertEl.className = 'alert alert-success show';
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

            } else {
                alertEl.textContent = result.message || 'Failed to change password';
                alertEl.className = 'alert alert-error show';
            }
        } catch (error) {
            const alertEl = document.getElementById('userDashboardAlert');
            alertEl.textContent = 'Error changing password';
            alertEl.className = 'alert alert-error show';
        }
    });

    window.onload = () => {
        showSection('home');
    };
</script>
</body>
</html>
